---
title: OSC 10-11
tags: 操作系统
categories: 课程学习
---

<font face="微软雅黑"> </font>
<center> 文件系统、文件系统实现</center>

<!-- more -->
<center> [本文地址](https://tiandaochouqin1.github.io/OSC-Chapter10-11/) </center>
<!-- TOC -->

- [文件系统](#文件系统)
- [文件系统的实现](#文件系统的实现)

<!-- /TOC -->

# 文件系统
文件系统由两部分组成：文件集合，每个文件存储相关数据；目录结构，组织系统内的所有文件并提供文件信息。
文件是由操作系统定义和实现的抽象数据类型。操作系统的主要任务是将逻辑文件概念映射到物理设备。

顺序访问：文件信息按顺序加以处理。
直接访问：基于文件的磁盘模型，磁盘允许对任何文件块的随机访问。
文件系统的每个设备都有内容的卷表或设备的目录，以列出设备上文件的位置。

多用户系统**单级目录**导致命名问题，**两级目录**通过为每个用户创建单独的目录以包括文件来解决这个问题。
**树形目录**是两级目录的自然扩展，允许用户创建子目录。
**无环图**目录允许共享子目录和文件，但是搜索和删除更为复杂。
**一般图结构**允许在共享文件和目录时完全的灵活性，有时需要采用垃圾收集以恢复未使用的磁盘空间。

共享文件和目录的实现：
* 链接，实际上是另一文件或子目录的指针
* 复制，在两个共享目录中复制有关他们的所有信息；修改文件时需要保持一致性。



# 文件系统的实现
**文件系统结构**
<img  src="https://raw.githubusercontent.com/tiandaochouqin1/Sources/main/images/filesys.jpg" alt="分层设计的文件系统" width=150  align=center >

**I/O控制层：**包括设备驱动程序和中断处理程序，以在主内存和磁盘系统之间传输消息。
**基本文件系统：**只需向适当的设备驱动程序发送通用指令，以读取和写入磁盘的物理块。
**文件组织模块**：知道文件及其逻辑块以及物理块。
**逻辑文件系统**：管理元数据信息。元数据包括文件系统的所有结果，而不包括实际数据。逻辑文件系统管理目录结构，以便根据给定文件名称为文件组织模块提供所需信息。
***
**文件系统的实现**
磁盘中的结构：
* 引导控制块：包括从该卷引导操作系统的所需信息。引导块或分区引导扇区。
* 卷控制块：包括卷或分区的详细信息，如分区的块的数量、块的大小、空闲块的数量和指针、空闲的FCB数量和FCB指针等。超级块或主控文件表。
* 目录结构:用于组织文件。
* FCB：包括该文件的许多详细信息、有一个唯一标识号，以便于目录条目相关联。

内存中的信息用于管理文件系统并通过缓冲来提高性能。这些数据在安装文件系统时被加载，在操作期间被更新，在卸载时被丢弃。
* 安装表：包含每个安装卷的有关信息。
* 目录结构的缓存：含有最近访问目录的信息。
* 整个系统的打开文件表：包括每个打开文件的FCB的副本。
* 每个进程的打开文件表：包括一个指向整个系统的打开文件表中的适当条目的指针，以及其他信息。
* 当对磁盘读出或写入时，缓冲区保存文件系统的块。

根分区，包括操作系统内核和其他系统文件，在启动时安装。其他卷可以再引导时自动安装或者以后手动安装。
***
**虚拟文件系统**
文件系统的实现由三个主要层组成。如图所示：
<img  src="https://raw.githubusercontent.com/tiandaochouqin1/Sources/main/images/vfs.jpg" alt="虚拟文件系统示意图" width=300  align=center >
第一层为文件系统接口，基于open()、read()、write()和close()调用即文件描述符。
第二层为虚拟文件系统层ＶＦＳ。1) 文件系统的通用操作和实现分开。2) 提供一种机制，以唯一表示网络上的文件。
第三层实现文件系统类型或远程文件系统协议的层。
***
**目录实现**
**线性列表：**采用文件名称和数据块指针的线性列表。查找文件需要线性搜索。
**哈希表**：根据文件名称获得一个值，并返回线性列表内的一个元素指针。

**分配方法**
**连续分配**：每个文件在磁盘上占有一组连续的块。支持顺序访问和直接访问。
用于访问连续分配文件的所需寻道时间最小，在确实需要寻道时所需寻道时间也最小。
文件动态地增长和缩小时系统开销很大；文件创建时要求用户提供文件的大小；存储空间浪费较大
**链接分配**：每个文件是磁盘块的链表，磁盘块可能会散布在磁盘的任何地方。目录包括文件第一块和最后一块的指针。顺序访问。解决了连续分配的外部碎片和大小声明问题。
将多个块组成簇可减少指针所需的空间。指针丢失或损坏的可靠性，可采用双向链表。
文件分配表FAT是一个变种。
**索引分配**：将所有指针放到一起，即索引块。支持直接访问。UNIX的innode。
每个文件都有自己的索引块，这是一个磁盘块地址的指针。目录则包含索引块的地址。
索引表空间和文件索引时间开销大。
<img  src="https://raw.githubusercontent.com/tiandaochouqin1/Sources/main/images/innode.jpg" alt="Unix的innode" width=400  align=center >

***
**空闲空间管理**
空闲空间分配方法影响磁盘空间的使用效率、文件系统的性能、外存的可靠性。
空闲空间列表记录了所有空闲磁盘空间，当创建文件时，搜索空闲空间列表以得到所需空间数量并分配。
使用方法包括位向量和链表。优化方法包括组合、计数和FAT。
**位图或位向量：**每块用一个位表示，0或1。
**链表:**将所有空闲磁盘块用链表链接起来，将指向第一个空闲块的指针保存在磁盘的特殊位置上，并缓存在内存中。遍历列表时效率低。
**组**：在第一个空闲块中存储n个空闲块的地址，最后一块包含另外n个空闲块的地址。
**计数：**记录第一块的地址和紧跟第一块的连续空闲块的数量n。

***
磁盘空间的使用效率取决于磁盘分配和目录算法。
**缓冲区缓存：**按面向文件系统的块来缓存，假设其中的块将很快再次使用。
**页面缓存：**采用虚拟内存技术，蒋文健按页面来缓存。与采用物理磁盘块来缓存相比风味高校。包括Solaris、Linux、Windows，采用页面缓存来缓存进程页面和文件数据，这称为统一虚拟内存。

目录管理程序常采用哈希表，快速且高效。
一致性检查程序：如UNIX系统程序fsck，比较目录结构的数据和磁盘的数据块，并试图修复发现的不一致。
基于日志的面向事务的文件系统：所有元数据修改按顺序写到日志，系统调用返回用户程序，这些日志条目对真实文件系统条目进行重放。日志文件是个环形缓冲区。

NFS将一组互连的工作站视作一组具有独立文件系统的独立机器，允许透明（根据显示请求）共享这些文件系统。基于客户机-服务器关系。客户机的系统调用转换成网络协议，再转换成服务器的文件系统操作。

文件系统中，日志结构和缓存等技术改善性能，而日志结构和RAID提高可靠性。

***

